---
title: Mapping underserved communities
format: html
editor: source

execute:
  echo: true
---

Below, we have provided instructions for replicating our methodology for mapping underserved communities in Tampa Bay. To view instructions for downloading the necessary source data from EJScreen, see [Getting demographic data](ejscreen.html).


Load the required R packages (install first as needed).

```{r}
#| message: false
#| warning: false
library(sf)
library(mapview)
library(dplyr)
library(RColorBrewer)
```

Load and view the data.

```{r}
#| out-width: "100%"
load(file = 'data/dattb.RData')
mapview(dattb)
```

You can see that some census tracts are only representative of the bay. We can clean up this data by retaining only the tracts in which the total population recorded in the latest American Community Survey ("ACSTOTPOP") was above zero. This will remove tracts in which no people reside (e.g., large waterbodies, parks, or other natural areas).

In line with EPA recommendations, we will use the following five demographic variables to identify underserved communities:

-   Percent classified as low income

-   Percent unemployed

-   Percent linguistically isolated (i.e., limited English speaking)

-   Percent with less than a high school education

-   Percent with low life expectancy

The EPA recommends flagging communities that fall within the 80th percentile (or higher) nationally as potentially disadvantaged. However, meeting this threshold in one variable alone is not necessarily an appropriate measure of disadvantage (e.g., a community of predominantly wealthy retirees would meet the unemployment threshold). For TBEP's Equity Strategy, we define an underserved community as one that meets at least two of these thresholds, which we believe reduces the number of errors in identification while recognizing that a community does not need to meet the threshold of every indicator to face significant challenges.

Run the code below to (1) remove unpopulated census tracts, (2) count the number of demographic thresholds met in each tract, and (3) identify which tracts will be classified as "underserved" communities.

```{r}
dattbindex <- dattb %>%
  filter(ACSTOTPOP > 0) %>%
  mutate(threshold_income = ifelse(P_LWINCPCT >= 80, 1, 0),
         threshold_unempl = ifelse(P_UNEMPPCT >= 80, 1, 0),
         threshold_lingui = ifelse(P_LNGISPCT >= 80, 1, 0),
         threshold_educat = ifelse(P_LESHSPCT >= 80, 1, 0),
         threshold_lifexp = ifelse(P_LIFEEXPCT >= 80, 1, 0)) %>%
  rowwise() %>%
  select(matches('^threshold|^ID')) %>% 
  mutate(threshold_N = sum(threshold_income,threshold_unempl,threshold_lingui,threshold_educat,threshold_lifexp, na.rm = TRUE)) %>%
  mutate(underserved = ifelse(threshold_N > 1, "Yes", "No"))
```

View the first five rows to see how the calculations have played out.

```{r}
head(dattbindex)
```

View a map showing the number of thresholds met per census tract (you may adapt to a different color scale of your choice).

```{r}
mapview(dattbindex, zcol = "threshold_N", col.regions = brewer.pal(6, "Reds"))
```

View the tracts that meet our definition of underserved communities. The areas in red are those that rank in the 80th percentile (or greater) nationally in 2 or more of the demographic screening variables. They will serve as priority areas for increasing the equitable distribution of benefits from TBEP's environmental programs.

```{r}
mapview(dattbindex, zcol = "underserved", col.regions = list("gray","red"))
```

You can save this final data as an RData object for future use.

```{r}
# save the layer as an RData object
save(dattbindex, file = 'data/dattbindex.RData')
```
